---
stages:
  - lint
  - test
  - build
  - publish

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  DEBIAN_FRONTEND: noninteractive

.matrix_template: &matrix_definition
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.9", "3.10", "3.11"]

before_script:
  - apt-get update -qq -y
  - apt-get install -qq -y build-essential libdbus-1-dev
  - python3 -m venv .venv
  - source .venv/bin/activate
  - python3 -m pip install .[dev]

cache:
  key:
    files:
      - pyproject.toml
      - .gitlab-ci.yml
    prefix: ${CI_JOB_NAME}
  paths:
    - .venv

lint:
  stage: lint
  image: python:${PYTHON_VERSION}-bullseye
  script:
    - task lint
  <<: *matrix_definition

test:
  stage: test
  image: python:${PYTHON_VERSION}-bullseye
  script:
    - task test
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    when: always
    reports:
      junit: report.xml
  <<: *matrix_definition

build:
  stage: build
  image: python:${PYTHON_VERSION}-bullseye
  script:
    - python3 -m pip install build
    - python3 -m build
  artifacts:
    paths:
      - dist/
  <<: *matrix_definition

publish:
  image: python:bullseye
  stage: publish
  needs:
    - job: build
      artifacts: true
  before_script:
    - python3 -m pip install twine
  script:
    - TWINE_PASSWORD=${TWINE_TOKEN} TWINE_USERNAME=${TWINE_USERNAME} python3 -m twine upload dist/*
  only:
    - tags
  when: manual
